<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Memo</title>
    
    
    <meta content="Memo" name="keywords">
    
    <meta content="Memo - Motivation 为了避免内存碎片化，或者为一些有着特殊内存需求的硬件，
比如GPUs、display controller以及camera等，在系统启动的时候，
会为他们预留一些memory pools，这些memory pools就由ION来管理。
通过ION就可以在硬件以及user space之间实现zero-copy的内存share
=&gt; 所以就是想要做kernelspace and user space的data sharing是zero copy =&gt; 然後手法就是先預留memory pool
ION implmentation ION通过ION heaps来展示presents它对应的memory pools。 不同的Android硬件可能会要求不同的ION heaps实现，
默认的ION驱动会提供如下三种不同的ION heaps实现 (1) ION_HEAP_TYPE_SYSTEM: memory allocated via vmalloc_user()
(2) ION_HEAP_TYPE_SYSTEM_CONTIG: memory allocated via kzalloc
(3) ION_HEAP_TYPE_CARVEOUT: carveout memory is physically contiguous and set aside at boot.
开发者可以自己实现更多的ION heaps。比如NVIDIA就提交了一种ION_HEAP_TYPE_IOMMU的heap，这种heap带有IOMMU功能。
不管哪一种ION heaps实现，他们都必须实现如下接口：
 struct ion_heap_ops { int (*allocate) (struct ion_heap *heap, struct ion_buffer *buffer, unsigned long len, unsigned long align, unsigned long flags); void (*free) (struct ion_buffer *buffer); int (*phys) (struct ion_heap *heap, struct ion_buffer *buffer, ion_phys_addr_t *addr, size_t *len); struct scatterlist *(*map_dma) (struct ion_heap *heap, struct ion_buffer *buffer); void (*unmap_dma) (struct ion_heap *heap, struct ion_buffer *buffer); void * (*map_kernel) (struct ion_heap *heap, struct ion_buffer *buffer); void (*unmap_kernel) (struct ion_heap *heap, struct ion_buffer *buffer); int (*map_user) (struct ion_heap *heap, struct ion_buffer *buffer, struct vm_area_struct *vma); }; 简单来说，接口的各个函数功能如下：" name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    

    

    

    
    
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>
    

    <link rel="stylesheet" href="/layui/css/layui.css">
    <link rel="stylesheet" href="/self/css/default.css">
    <script async src="/layui/layui.js"></script>

    <link rel="stylesheet" async href="/self/css/markdown.min.css">
    <link rel="stylesheet" async href="/self/css/gallery.css">
    
    
    

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
    <script async src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" integrity="sha256-h2tMEmhemR2IN4wbbdNjj9LaDIjzwk2hralQwfJmBOE=" crossorigin="anonymous"></script></head>

<body>
    
    <header class="layui-header layui-bg-cyan">

    
    
    <a class="nav-self-logo" href="/">
        Memo
    </a>

    <ul class="layui-nav layui-layout-right layui-bg-cyan" lay-filter="">
        
        
        <li class="layui-nav-item" id="nav_big"><a href="/post/">Posts</a></li>
        

        
            
                <li class="layui-nav-item" id="nav_big"><a href="/about/">About</a></li>
            
        

        
        <li class="layui-nav-item" id="nav_small">
            <a href="javascript:;">
                <i class="layui-icon layui-icon-app" style="font-size: 24px;"></i>
            </a>

            <dl class="layui-nav-child">
                
                <dd><a href="/post/">Posts</a></dd>
                

                
                    
                        <dd><a href="/about/">About</a></dd>
                    
                
            </dl>
        </li>
    </ul>
</header>

<script>
layui.use('element', function(){
  var element = layui.element;
});
</script>
        <div id="content" style="min-height:80%">
<div class="layui-container" style="margin-bottom: 10px">
    

    <div class="layui-row layui-col-space10">
        <div class="layui-col-md12 layui-col-sm12 layui-col-xs12">
            <div class="layui-card single-card">
                <br />
                <blockquote class="self-elem-quote self-elem-quote-bg-red markdown-body single-title" >
                    <h1></h1>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>0001-01-01</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/sw-info-android-ion/">
            <span class="layui-badge layui-bg-orange" style="vertical-align: 2px;">SW-INFO-Android-ION</span>
        </a>
    

    
    
    
</h3>
                </blockquote>
                <div class="layui-card-body markdown-body single-content">
                    <h1 id="motivation">Motivation</h1>
<p>为了避免内存碎片化，或者为一些有着特殊内存需求的硬件，<br>
比如GPUs、display controller以及camera等，在系统启动的时候，<br>
会为他们预留一些memory pools，这些memory pools就由ION来管理。<br>
通过ION就可以在硬件以及user space之间实现zero-copy的内存share<br>
=&gt; 所以就是想要做kernelspace and user space的data sharing是zero copy <br>
=&gt; 然後手法就是先預留memory pool</p>
<h1 id="ion-implmentation">ION implmentation</h1>
<p>ION通过ION heaps来展示presents它对应的memory pools。 <br>
不同的Android硬件可能会要求不同的ION heaps实现，<br>
默认的ION驱动会提供如下三种不同的ION heaps实现 <br>
(1) ION_HEAP_TYPE_SYSTEM: memory allocated via vmalloc_user()<br>
(2) ION_HEAP_TYPE_SYSTEM_CONTIG: memory allocated via kzalloc<br>
(3) ION_HEAP_TYPE_CARVEOUT: carveout memory is physically contiguous and set aside at boot.<br>
开发者可以自己实现更多的ION heaps。比如NVIDIA就提交了一种ION_HEAP_TYPE_IOMMU的heap，这种heap带有IOMMU功能。<br>
不管哪一种ION heaps实现，他们都必须实现如下接口：</p>
<pre><code>   struct ion_heap_ops {
    int (*allocate) (struct ion_heap *heap,
             struct ion_buffer *buffer, unsigned long len,
             unsigned long align, unsigned long flags);
    void (*free) (struct ion_buffer *buffer);
    int (*phys) (struct ion_heap *heap, struct ion_buffer *buffer,
             ion_phys_addr_t *addr, size_t *len);
    struct scatterlist *(*map_dma) (struct ion_heap *heap,
             struct ion_buffer *buffer);
    void (*unmap_dma) (struct ion_heap *heap, 
             struct ion_buffer *buffer);
    void * (*map_kernel) (struct ion_heap *heap, 
             struct ion_buffer *buffer);
    void (*unmap_kernel) (struct ion_heap *heap, 
             struct ion_buffer *buffer);
    int (*map_user) (struct ion_heap *heap, struct ion_buffer *buffer,
             struct vm_area_struct *vma);
   };
</code></pre><p>简单来说，接口的各个函数功能如下：<br>
(1) allocate()和free()分别用来从heap中分配或者释放一个ion_buffer对象    <br>
(2) 对于物理连续的内存，phys()用来得到ion_buffer对象的物理内存地址及其大小。<br>
如果heap没有提供物理连续的内存，那么它也可以不用提供这个接口。<br>
其中，ion_phys_addr_t将来会被定义在/include/linux/types.h中的phys_addr_t替代。<br>
(3) map_dma()和unmap_dma()分别来用使ion_buffer对象为DMA <br>
（Direct Memory Access，直接内存存取。顾名思义，不占用cpu资源，<br>
从一个硬件存储区域把一部分连续的数据复制到另一个硬件存储区域）做好准备或者取消做好准备  <br>
(4) map_kernel()和unmap_kernel()分别用来把physical memory映射(map) <br>
到内核虚拟地址空间(kernel virtual address space)或者取消映射  <br>
(5) map_user()用来把physical memory映射(map)到用户内存空间(user space)。<br>
为什么没有对应的unmap_user()呢？因为，这个映射用一个file descriptor来表示， <br>
当这个file descriptor关闭的时候，这个映射关系就自动取消了。</p>
<h1 id="ion-usage">ION usage</h1>
<p>(1) 使用场景<br>
典型的，在用户空间使用的设备访问库(user space device access libraries)<br>
一般使用ION来分配大块连续的media buffers。<br>
比如，still camera library分配一个capture buffer来供camera device使用。<br>
当这个buffer填满video data的时候，这个library就能把这块buffer传递给kernel，<br>
然后让JPEG硬编码模块来处理。</p>
<p>(2) 具体使用细节<br>
在user space 的C/C++程序能够能够分配ION内存之前，它必须获得访问/dev/ion的权限。<br>
通过调用open(&quot;/dev/ion&rdquo;, O_RDONLY)就可获得一个以handle形式返回的file descriptor，<br>
这个file descriptor用来代表一个ION client。<br>
注意，虽然传给open一个O_RDONLY参数，但是你仍然可对这块memory进行写操作。<br>
在一个user process中最多有一个client。当有了一个client之后，就可以开始分配ION内存。<br>
为了分配内存，client必须填满下面的ion_allocation_data结构，handle除外，因为它是output参数。<br>
其他三个参数分别指明内存的大小、对齐方式以及flags。</p>
<p>flags是一个bit mask，<br>
用来说明可以从哪些heaps中分配想要的内存。其决定顺序由系统启动时，<br>
通过ion_device_add_heap()添加的heap顺来决定。<br>
比如，ION_HEAP_TYPE_CARVEOUT是在ION_HEAP_TYPE_CONTIG之前被add的，<br>
那么如果flags = ION_HEAP_TYPE_CONTIG | ION_HEAP_TYPE_CARVEOUT，<br>
那么就是先尝试分配ION_HEAP_TYPE_CARVEOUT类型的heap，<br>
如果不行，再尝试分配ION_HEAP_TYPE_CONTIG类型的heap。</p>
<pre><code>   struct ion_allocation_data {
        size_t len;
        size_t align;
        unsigned int flags;
        struct ion_handle *handle;
   }
</code></pre><h1 id="example">Example</h1>
<p>在这个Demo中，fd在同一个client中被share使用</p>
<pre><code>#include&lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;sys/mman.h&gt;

#include &quot;/home/developer/kernel3.4/goldfish/include/linux/ion.h&quot;

void main()
{
    struct ion_fd_data fd_data;
    struct ion_allocation_data ionAllocData;
    ionAllocData.len=0x1000;
    ionAllocData.align = 0;
    ionAllocData.flags = ION_HEAP_TYPE_SYSTEM;

    int fd=open(&quot;/dev/ion&quot;,O_RDWR);
    ioctl(fd,ION_IOC_ALLOC, &amp;ionAllocData);
    fd_data.handle = ionAllocData.handle;
    ioctl(fd,ION_IOC_SHARE,&amp;fd_data); 
    int *p = mmap(0,0x1000,PROT_READ|PROT_WRITE,MAP_SHARED,fd_data.fd,0);
    p[0]=99;
    perror(&quot;test&quot;);
    printf(&quot;hello all %d\n&quot;,p[0]);
}
</code></pre></div>
            </div>
        </div>

        
    </div>
</div>


        </div><footer>
    

    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs6">
                <h3> Related Sites </h3>
            </div>
        </div>
        <div class="layui-row">
            
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs12">
                <a href="/"><p class="footer-url">home</p></a>
            </div>
            
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs12">
                <a href="/about/"><p class="footer-url">About</p></a>
            </div>
            
        </div>
    </div>
    
    
    <div class="layui-container">
        <p class="copyright">&copy; All rights reserved. Powered by <a href='https://gohugo.io' style='color:#FFFFFF'>Hugo</a> and <a href='https://github.com/ertuil/erblog' style='color:#FFFFFF'>Erblog</a>.</p>
    </div>
</footer>
</body>
</html>
