<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Memo</title>
    
    
    <meta content="Memo" name="keywords">
    
    <meta content="Memo - https://blog.gcp.expert/cloud-machine-learning-beginning/
Cloud ML Engine 也是一個您客製化機器學習模型的一個工具，
您可以在上面執行任何一種 TensorFlow 架構，像是 Google 相簿和和 Google Cloud Speech 都是 ML Engine 運用下的成功範例。
Cloud ML Engine 產品特色
HyperTune
ML Engine 結合了 HyperTune，您不用再手動找出所需數據，HyperTune 具備自動調整高等參數的功能，讓您能更有效的建立您的模型。
可攜式模型
您可以透過下載 Cloud Machine Learning 訓練過的模型，提供本機執行或行動整合。
可擴充的代管服務 =&gt; 這個才是我想要用的 Google 利用支援 CPU 和 GPU 的代管型分散式訓練基礎架構，讓您能同時支援以 TB 等級的資料和上千位的使用者，您也不需擔心基礎架構問題。
整合性高
跟過往的 Google 產品相同的是：Cloud ML Engine 能與其他 Google 產品整合，您可以使用來自像是 Cloud Storage 等其他來源的資料、搭配 Cloud Dataflow 的功能處理、Cloud Datalab 的模型建立。 Cloud Machine Learning 是 Google Cloud Platform 對於深度學習提供的管理服務。
它可以讓您建立作用於任何大小、任何資料的學習模型，並藉由 TensorFlow 框架打造您的服務。" name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    

    

    

    
    
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>
    

    <link rel="stylesheet" href="/layui/css/layui.css">
    <link rel="stylesheet" href="/self/css/default.css">
    <script async src="/layui/layui.js"></script>

    <link rel="stylesheet" async href="/self/css/markdown.min.css">
    <link rel="stylesheet" async href="/self/css/gallery.css">
    
    
    

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
    <script async src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" integrity="sha256-h2tMEmhemR2IN4wbbdNjj9LaDIjzwk2hralQwfJmBOE=" crossorigin="anonymous"></script></head>

<body>
    
    <header class="layui-header layui-bg-cyan">

    
    
    <a class="nav-self-logo" href="/">
        Memo
    </a>

    <ul class="layui-nav layui-layout-right layui-bg-cyan" lay-filter="">
        
        
        <li class="layui-nav-item" id="nav_big"><a href="/post/">Posts</a></li>
        

        
            
                <li class="layui-nav-item" id="nav_big"><a href="/about/">About</a></li>
            
        

        
        <li class="layui-nav-item" id="nav_small">
            <a href="javascript:;">
                <i class="layui-icon layui-icon-app" style="font-size: 24px;"></i>
            </a>

            <dl class="layui-nav-child">
                
                <dd><a href="/post/">Posts</a></dd>
                

                
                    
                        <dd><a href="/about/">About</a></dd>
                    
                
            </dl>
        </li>
    </ul>
</header>

<script>
layui.use('element', function(){
  var element = layui.element;
});
</script>
        <div id="content" style="min-height:80%">
<div class="layui-container" style="margin-bottom: 10px">
    

    <div class="layui-row layui-col-space10">
        <div class="layui-col-md12 layui-col-sm12 layui-col-xs12">
            <div class="layui-card single-card">
                <br />
                <blockquote class="self-elem-quote self-elem-quote-bg-red markdown-body single-title" >
                    <h1></h1>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>0001-01-01</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/tool-google-cloud-ml/">
            <span class="layui-badge layui-bg-orange" style="vertical-align: 2px;">TOOL-Google-Cloud-ML</span>
        </a>
    

    
    
    
</h3>
                </blockquote>
                <div class="layui-card-body markdown-body single-content">
                    <p><a href="https://blog.gcp.expert/cloud-machine-learning-beginning/">https://blog.gcp.expert/cloud-machine-learning-beginning/</a><br>
Cloud ML Engine 也是一個您客製化機器學習模型的一個工具，<br>
您可以在上面執行任何一種 TensorFlow 架構，像是 Google 相簿和和 Google Cloud Speech 都是 ML Engine 運用下的成功範例。<br>
Cloud ML Engine 產品特色<br>
HyperTune<br>
ML Engine 結合了 HyperTune，您不用再手動找出所需數據，HyperTune 具備自動調整高等參數的功能，讓您能更有效的建立您的模型。<br>
可攜式模型<br>
您可以透過下載 Cloud Machine Learning 訓練過的模型，提供本機執行或行動整合。<br>
可擴充的代管服務 =&gt; 這個才是我想要用的 <br>
Google 利用支援 CPU 和 GPU 的代管型分散式訓練基礎架構，讓您能同時支援以 TB 等級的資料和上千位的使用者，您也不需擔心基礎架構問題。<br>
整合性高<br>
跟過往的 Google 產品相同的是：Cloud ML Engine 能與其他 Google 產品整合，您可以使用來自像是 Cloud Storage 等其他來源的資料、搭配 Cloud Dataflow 的功能處理、Cloud Datalab 的模型建立。 <br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_124.png" alt="image"></p>
<p>Cloud Machine Learning 是 Google Cloud Platform 對於深度學習提供的管理服務。<br>
它可以讓您建立作用於任何大小、任何資料的學習模型，並藉由 TensorFlow 框架打造您的服務。<br>
您立即可以將訓練模型放置於全球的 prediction 平台，能支持成千上萬的使用者與 TB 等級的資料。<br>
除此之外，此項服務同時整合了 Cloud Dataflow, Cloud Storage 甚至 BigQuery。<br>
現在我們就來使用看看如何簡單的進行手把手 Cloud Machine Learning：</p>
<h2 id="起始設定">起始設定</h2>
<p>打開 Google Cloud Shell 並從 GitHub 下載範例程式，以下的步驟使用者需要有 Editor 的權限才能運作。<br>
CLOUD SHELL<br>
Manage your infrastructure and applications from the command-line in any browser<br>
Google Cloud Shell provides you with command-line access to your cloud resources directly from your browser.<br>
You can easily manage your projects and resources without having to install the Google Cloud SDK or other tools<br>
on your system. With Cloud Shell, the Cloud SDK gcloud command-line tool and other utilities you need are always available,<br>
up to date and fully authenticated when you need them.<br>
再按了editor後 就可以看到底下的畫面<br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_118.png" alt="image"></p>
<p>這邊有個Google提供的範例flower<br>
解壓縮該檔案並移動路徑至 flowers 的目錄底下，以下的指令都需要再 flowers 的目錄底下執行：<br>
wget <a href="https://github.com/GoogleCloudPlatform/cloudml-samples/archive/master.zip">https://github.com/GoogleCloudPlatform/cloudml-samples/archive/master.zip</a><br>
unzip master.zip<br>
cd cloudml-samples-master/flowers<br>
使用 pip 來下載所需要的套件<br>
pip install &ndash;user -r requirements.txt<br>
可以看到google提供的clould ml範例裡面有mnist,xgboost ..etc<br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_119.png" alt="image"></p>
<h3 id="flower-model">flower model</h3>
<p>&ldquo;&ldquo;&ldquo;Flowers classification model.&rdquo;&rdquo;&rdquo;<br>
import enum<br>
import logging<br>
import tensorflow as tf<br>
from tensorflow.contrib import layers<br>
from tensorflow.contrib.slim.python.slim.nets import inception_v3 as inception =&gt; 可以看到他好像是用inceptionV3   <br>
from tensorflow.python.saved_model import builder as saved_model_builder<br>
from tensorflow.python.saved_model import signature_constants<br>
from tensorflow.python.saved_model import signature_def_utils<br>
from tensorflow.python.saved_model import tag_constants<br>
from tensorflow.python.saved_model import utils as saved_model_utils</p>
<p>def create_model(args):<br>
&ldquo;&ldquo;&ldquo;Factory method that creates model to be used by generic task.py.&rdquo;&rdquo;&rdquo;<br>
return Model(args.label_count, args.dropout, args.inception_checkpoint_file)</p>
<p>class Model(object):=&gt;有個flower辨別的model <br>
&ldquo;&ldquo;&ldquo;TensorFlow model for the flowers problem.&rdquo;&rdquo;&rdquo;</p>
<p>def <strong>init</strong>(self, label_count, dropout, inception_checkpoint_file):<br>
self.label_count = label_count<br>
self.dropout = dropout<br>
self.inception_checkpoint_file = inception_checkpoint_file</p>
<p>def build_inception_graph(self):=&gt;透過這個可以建立inceptionV3 model(並包含input/output)   <br>
&ldquo;&ldquo;&ldquo;Builds an inception graph and add the necessary input &amp; output tensors.</p>
<pre><code>  To use other Inception models modify this file. Also preprocessing must be  
  modified accordingly.  

  See tensorflow/contrib/slim/python/slim/nets/inception_v3.py for  
  details about InceptionV3.  

Returns:  
  input_jpeg: A placeholder for jpeg string batch that allows feeding the  
              Inception layer with image bytes for prediction.  
  inception_embeddings: The embeddings tensor.  
&quot;&quot;&quot;  

# These constants are set by Inception v3's expectations.  
height = 299  
width = 299  
channels = 3  

image_str_tensor = tf.placeholder(tf.string, shape=[None])  

# The CloudML Prediction API always &quot;feeds&quot; the Tensorflow graph with  
# dynamic batch sizes e.g. (?,).  decode_jpeg only processes scalar  
# strings because it cannot guarantee a batch of images would have  
# the same output size.  We use tf.map_fn to give decode_jpeg a scalar  
# string from dynamic batches (tf.map_fn =&gt; 有點像是call back function)   
def decode_and_resize(image_str_tensor):  
  &quot;&quot;&quot;Decodes jpeg string, resizes it and returns a uint8 tensor.&quot;&quot;&quot;  
  image = tf.image.decode_jpeg(image_str_tensor, channels=channels)  
  # Note resize expects a batch_size, but tf_map supresses that index,  
  # thus we have to expand then squeeze.  Resize returns float32 in the  
  # range [0, uint8_max]  
  image = tf.expand_dims(image, 0)  
  image = tf.image.resize_bilinear(  
      image, [height, width], align_corners=False)  
  image = tf.squeeze(image, squeeze_dims=[0])  
  image = tf.cast(image, dtype=tf.uint8)  
  return image  

image = tf.map_fn (  
    decode_and_resize, image_str_tensor, back_prop=False, dtype=tf.uint8)  
# convert_image_dtype, also scales [0, uint8_max] -&gt; [0 ,1).  
image = tf.image.convert_image_dtype(image, dtype=tf.float32)  

# Then shift images to [-1, 1) for Inception.  
image = tf.subtract(image, 0.5)  
image = tf.multiply(image, 2.0)  

# Build Inception layers, which expect A tensor of type float from [-1, 1)  
# and shape [batch_size, height, width, channels].  
with slim.arg_scope(inception.inception_v3_arg_scope()):  
  _, end_points = inception.inception_v3(image, is_training=False)  

inception_embeddings = end_points['PreLogits']  
inception_embeddings = tf.squeeze(  
    inception_embeddings, [1, 2], name='SpatialSqueeze')  
return image_str_tensor, inception_embeddings  
</code></pre>
<p>至 GCP Project 啟用 Cloud Machine Learning Engine and Compute Engine APIs
Note:要先開啟project的計費功能, 這樣才可以enable cloud mahcin learning engine API<br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_120.png" alt="image"><br>
要設定憑證,將憑證新增至您的專案 <br>
如要在應用程式中使用這組金鑰，請以 key=API_KEY 參數的形式來傳送金鑰<br>
AIzaSyC2__qNt0ihD6qF30ad52Uvqt2tRNm6kJc</p>
<p>安裝並初始化 Cloud SDK<br>
用Linux的版本安裝即可<br>
注意要先用browser開啟google權限,要讓google cloud可以access<br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_121.png" alt="image"></p>
<p>安裝完 Tensorflow 後可以照著此連結的步驟，測試 Tensorflow 是否成功安裝，結果如下：</p>
<p>設置 Cloud Storage Bucket<br>
設置 Project 以及 Bucket 的環境變數<br>
PROJECT_ID=$(gcloud config list project &ndash;format &ldquo;value(core.project)&quot;)<br>
BUCKET_NAME=${PROJECT_ID}-mlengine<br>
確認 Project id 以及 Bucket 的名稱是否正確<br>
echo $PROJECT_ID<br>
echo $BUCKET_NAME</p>
<p>選定一個 可以跑Cloud ML service 的 Region (例如：us-central1)<br>
REGION=us-central1<br>
us-central1看起來處理器最好<br>
有TPU_V2還有NVIDIA TESLA V100	
英偉達發布Tesla V100 史上最強核彈售價102萬元<br>
單精度浮點性能高達15 TFLOPS，雙精度浮點7.5 TFLOPS，顯存帶寬900GB/s是P1000的2倍多。<br>
看起來好像也還好&hellip;<br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_122.png" alt="image"></p>
<p>切換到/GoogleCloud/cloudml-samples-master/flowers<br>
gsutil mb -l $REGION gs://$BUCKET_NAME<br>
執行可能會有錯誤, 是因為你要建立bucket才行(bucket就是一個儲藏空間而已)    <br>
<a href="https://console.cloud.google.com/storage/browser?_ga=2.250402305.-681519371.1544509115&amp;project=third-technique-225213&amp;folder&amp;organizationId">https://console.cloud.google.com/storage/browser?_ga=2.250402305.-681519371.1544509115&amp;project=third-technique-225213&amp;folder&amp;organizationId</a><br>
<img src="https://github.com/evansin100/Cloud-Machine-Learning-/blob/master/Selection_123.png" alt="image"></p>
<p>好像要把權限加到使用者才行？<br>
Click the drop-down menu associated with the bucket to which you want to grant a member a role.<br>
The drop-down menu appears as three vertical dots to the far right of the bucket&rsquo;s row.<br>
Choose Edit bucket permissions.<br>
In the Add members field, enter one or more identities that need access to your bucket.</p>
</div>
            </div>
        </div>

        
    </div>
</div>


        </div><footer>
    

    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs6">
                <h3> Related Sites </h3>
            </div>
        </div>
        <div class="layui-row">
            
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs12">
                <a href="/"><p class="footer-url">home</p></a>
            </div>
            
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs12">
                <a href="/about/"><p class="footer-url">About</p></a>
            </div>
            
        </div>
    </div>
    
    
    <div class="layui-container">
        <p class="copyright">&copy; All rights reserved. Powered by <a href='https://gohugo.io' style='color:#FFFFFF'>Hugo</a> and <a href='https://github.com/ertuil/erblog' style='color:#FFFFFF'>Erblog</a>.</p>
    </div>
</footer>
</body>
</html>
